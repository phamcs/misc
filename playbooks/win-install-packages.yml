---
- name: Install Packages
  hosts: all
  become: true
  tasks:

    - name: set the default shell to PowerShell
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\OpenSSH
        name: DefaultShell
        data: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
        type: string
        state: present
      when: ansible_os_family == "Windows"

    - name: reset SSH connection after shell change
      ansible.builtin.meta: reset_connection
      when: ansible_os_family == "Windows"

    - name: Install using powershell
      win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        choco upgrade -y chocolatey

    # - name: Install windows packages
    #   win_chocolatey:
    #     name: '{{ item }}'
    #     state: present
    #   loop:
    #   - 7zip
    #   - awscli
    #   - git
    #   - golang
    #   - nodejs-lts
    #   - notepadplusplus
    #   - python3
    #   - ruby
    #   - VisualStudioCode
    #   when: ansible_facts['os_family'] == "Windows"
